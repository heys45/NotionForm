<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="form.css">
    <title>Document</title>
</head>
<body>
  
    <!-- 更新日時の表示 -->
    <p id="last-updated"></p>
    <script>
      // ページの最終更新日時を取得
      const lastUpdated = new Date(document.lastModified);
  
      // 現在の日時を取得
      const now = new Date();
  
      // 日時のフォーマットを設定
      const options = {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: false
      };
  
      // 最終更新日時と現在日時を比較して表示
      if (lastUpdated.getTime() === 0) {
        document.getElementById("last-updated").innerHTML = "このページは更新されていません。";
      } else if (lastUpdated.getTime() === now.getTime()) {
        document.getElementById("last-updated").innerHTML = "このページは現在更新されています。";
      } else if (lastUpdated < now) {
        document.getElementById("last-updated").innerHTML = "このページは " + lastUpdated.toLocaleDateString("ja-JP", options) + " に更新されました。";
      }
    </script>

    <!-- タスク情報の取得 -->
    <script>
      // POSTリクエストの送信
      fetch("https://script.google.com/macros/s/AKfycbwvbVZYgBgS5XOdT4Lm21TOVjzFqzOmWfblACSOWhDwIirX1UWcKukY4pvozxxsGNmw/exec", {
        method: 'POST',
        headers: {
            'Content-Type': 'text/plain',
        },
        body: JSON.stringify({
            salesId: '9' // 検索条件
        }),
        mode: 'cors', //CORS対応
      })
      .then(response => response.text()) 
      .then(data => {
        var body = document.getElementsByTagName("body")[0];
        document.getElementById("last-updated").insertAdjacentHTML("afterend", data);
        

        // ここから日付の成形
        let select = document.getElementById("title");
        let option;
        let table = document.getElementsByTagName("table")[0];
        let rows = table.rows;
        for (let i = 1; i < rows.length; i++) {
          const dateCell = rows[i].querySelector('td:last-child');
          const dateText = dateCell.innerText;
          const dateText2 = dateText.match(/\d{1,2}\/\d{1,2} \d{1,2}:\d{1,2}/);
          const dateText3 = dateText2[0];
          dateCell.innerText = dateText3;
        }


        // クライアント一覧取得
        const clients = Array.from(new Set([...document.querySelectorAll('table tbody td:nth-child(6)')].map(td => td.textContent)));
        // クライアント選択ボタンを作成する
        const client_buttons = document.createElement("div");
        client_buttons.setAttribute("id","client-buttons");
        table.insertAdjacentHTML("beforebegin", client_buttons.outerHTML);
        const clientButtons = document.getElementById('client-buttons');
        clients.forEach((client, index) => {
          // ボタン要素を作成
          const button = document.createElement('button');
          button.textContent = client;
          button.addEventListener('click', () => {
            // クリックされたボタンにactiveクラスを追加
            const currentButton = document.querySelector('#client-buttons button.active');
            if (currentButton) {
              currentButton.classList.remove('active');
            }
            button.classList.add('active');


            // セレクトの中身をクリア
            select.innerHTML = '';

            // 選択してくださいのデフォルトのoptionを作成
            let option = document.createElement("option");
            option.text = "選択してください";
            option.value = "選択してください";
            select.add(option);

            // 新規タスク作成のoptionを作成
            option = document.createElement("option");
            option.text = "新規タスク作成";
            option.value = "新規タスク作成";
            select.add(option);

            // クライアントが選択された時選択肢作成処理
            const rows = Array.from(document.querySelectorAll('tbody tr')).slice(1); // ヘッダーを除外
            rows.forEach(row => {
              const clientCell = row.cells[5];
              if (clientCell.textContent === client) {
                // クライアントが選択中のタスク内容のoptionを作成
                option = document.createElement("option");
                option.text = row.cells[0].innerText;
                option.value = row.cells[0].innerText;
                select.add(option);
              } 
            });

            // クライアントが選択された時の表切り替え処理（画面サイズ変更にも行う）
            rows.forEach(row => {
              const clientCell = row.cells[5];
              if (clientCell.textContent === client) {
                row.style.display = (window.innerWidth <= 680) ? 'flex' : 'table-row';
              } else {
                row.style.display = 'none';
              }
            });
          });
          // ボタンを追加
          clientButtons.appendChild(button);
          // 最初のクライアントを選択状態にする
          if (index === 0) {
            button.click();
            button.classList.add('active');
          }
        });
      });

      function handleResize(){
            const currentButton = document.querySelector('#client-buttons button.active');
            const client =currentButton.textContent;
            const rows = Array.from(document.querySelectorAll('tbody tr')).slice(1); // ヘッダーを除外
            rows.forEach(row => {
              const clientCell = row.cells[5];
              if (clientCell.textContent === client) {
                row.style.display = (window.innerWidth <= 680) ? 'flex' : 'table-row';
              } else {
                row.style.display = 'none';
              }
            });}
      window.addEventListener('resize', handleResize);

    </script>
    

    <!-- ここからフォーム -->
    <form id="myForm" >
        <label for="title">タスク内容:</label><br>
        <select id="title" name="select:タスク内容" onchange="showOtherTitle()">
          <option value="" selected disabled>選択してください</option>
          <option value="新規タスク作成">新規タスク作成</option>
        </select>
        <input type="text" id="otherTitle" name="other:タスク内容" style="display:none;"><br>
        
        <label for="estimation">見積:</label><br>
        <input type="number" id="estimation" name="number:見積"><br>
        <label for="actual">実工数:</label><br>
        <input type="number" id="actual" name="number:実工数"><br>
        <label for="progress">進捗:</label><br>
        <input type="number" id="progress" name="number:進捗"><br>
        <label for="taskDetail">Task Detail:</label><br>
        <input type="text" id="taskDetail" name="rich text:Task Detail"><br>
        <label for="client">クライアント:</label><br>
        <select id="client" name="select:クライアント">
          <option value="A社">A社</option>
          <option value="B社">B社</option>
          <option value="C社">C社</option>
        </select><br><br>
        <input type="submit" value="送信">
      </form>

      <script>
        function showOtherTitle() {
          let select = document.getElementById("title");
          let otherTitle = document.getElementById("otherTitle");
          if (select.value === "新規タスク作成") {
            otherTitle.style.display = "inline-block";
          } else {
            otherTitle.style.display = "none";
          }
        }
      </script>


      <script>
        // フォームの送信をハンドルする関数
        const handleSubmit = async (event) => {
          event.preventDefault(); // デフォルトの送信をキャンセル
          const form = document.querySelector('#myForm');
          const formData = new FormData(form);
          const data = {};
          // FormDataオブジェクトから連想配列に変換
          for (const [key, value] of formData.entries()) {
            data[key] = value;
          }

        // もし「その他」が選択された場合、テキストボックスの値を利用する
        if (data["select:タスク内容"] === "その他") {
          data["select:タスク内容"] = data["other:タスク内容"];
        }

        // taskDetailを整形してdataに追加
        const now = new Date();
        const formattedDate = now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate();
        const formattedTime = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
        const taskDetail = data["rich text:Task Detail"];
        const actual = data["number:実工数"];
        const formattedTaskDetail = `${actual} ${formattedDate} ${formattedTime}\n${taskDetail}`;
        data["rich text:Task Detail"] = formattedTaskDetail;

        const response = await fetch("https://script.google.com/macros/s/AKfycbyZQosu3WeC4dq-SWiU2yOrTJr1Gjea6s4EvjlfzuFKpADlPdTCojiENHreCnN5Nn86/exec", {
        method: 'POST',
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded' // Content-Typeヘッダーを設定
        },
        body: Object.keys(data).map(key => encodeURIComponent(key) + '=' + encodeURIComponent(data[key])).join('&')
        });
          if (response.ok) {
            console.log('データが正常に送信されました');
            form.reset(); // フォームの入力値をリセット
          } else {
            console.log('データの送信に失敗しました');
          }
        };
        const form = document.querySelector('#myForm');
        form.addEventListener('submit', handleSubmit);
      </script>







</body>
</html>