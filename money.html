<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>タスク管理アプリ</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="form.css">
    <link rel="stylesheet" href="table.css">

    <title>Document</title>
</head>
<body>
<!-- フォームを用意する。 -->
<form id="myForm">
    <div class="form-title">
        <h2>経費管理フォーム</h2>
    </div>
    <div class="form-box">
        <label for="date" class="form-label">日付:</label>
        <input type="date" id="date" name="日付">
    </div>
    <div class="form-box">
        <label for="category" class="form-label">カテゴリ:</label>
        <select id="category" name="カテゴリ">
            <option value="" selected disabled>選択してください</option>
            <option value="食費">食費</option>
            <option value="交通費">交通費</option>
            <option value="通信費">通信費</option>
            <option value="娯楽費">娯楽費</option>
            <option value="住居費">住居費</option>
            <option value="その他">その他</option>
        </select>
    </div>
    <div class="form-box">
        <label for="expense" class="form-label">出費:</label>
        <input type="number" id="expense" name="出費">
    </div>
    <div class="form-box">
        <label for="memo" class="form-label">メモ:</label>
        <textarea id="memo" name="メモ"></textarea>
    </div>
    <div class="form-box">
        <label for="paymentMethod" class="form-label">支払い方法:</label>
        <select id="paymentMethod" name="支払い方法">
            <option value="" selected disabled>選択してください</option>
            <option value="現金">現金</option>
            <option value="クレジットカード">クレジットカード</option>
            <option value="デビットカード">デビットカード</option>
            <option value="電子マネー">電子マネー</option>
            <option value="その他">その他</option>
        </select>
    </div>
    <div class="form-box">
        <label for="expenseCheck" class="form-label">経費:</label>
        <input type="checkbox" id="expenseCheck" name="経費">
    </div>
    <div class="form-box">
        <label for="accountingItem" class="form-label">計上項目:</label>
        <select id="accountingItem" name="計上項目">
            <option value="" selected disabled>選択してください</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="E">E</option>
        </select>
    </div>
    <div class="form-box">
        <label for="accountingAmount" class="form-label">計上額:</label>
        <input type="number" id="accountingAmount" name="計上額">
    </div>
    <div class="form-box">
        <label for="expenseMemo" class="form-label">経費メモ:</label>
        <textarea id="expenseMemo" name="経費メモ"></textarea>
    </div>
    <div class="form-box">
        <input type="submit" value="経費を保存">
    </div>
</form>

<!-- 更新日時の表示 -->
<p id="last-updated"></p>
<script>
  // ページの最終更新日時を取得
  const lastUpdated = new Date(document.lastModified);

  // 現在の日時を取得
  const now = new Date();

  // 日時のフォーマットを設定
  const options = {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: 'numeric',
    minute: 'numeric',
    second: 'numeric',
    hour12: false
  };

  // 最終更新日時と現在日時を比較して表示
  if (lastUpdated.getTime() === 0) {
    document.getElementById("last-updated").innerHTML = "このページは更新されていません。";
  } else if (lastUpdated.getTime() === now.getTime()) {
    document.getElementById("last-updated").innerHTML = "このページは現在更新されています。";
  } else if (lastUpdated < now) {
    document.getElementById("last-updated").innerHTML = "このページは " + lastUpdated.toLocaleDateString("ja-JP", options) + " に更新されました。";
  }
</script>

    <!-- タスク情報の取得、テーブルの表示
    <script>
    function script1() {
      // POSTリクエストの送信
      fetch("https://script.google.com/macros/s/AKfycbwvbVZYgBgS5XOdT4Lm21TOVjzFqzOmWfblACSOWhDwIirX1UWcKukY4pvozxxsGNmw/exec", {
        method: 'POST',
        headers: {
            'Content-Type': 'text/plain',
        },
        body: JSON.stringify({
            salesId: '9' // 検索条件
        }),
        mode: 'cors', //CORS対応
      })
      .then(response => response.text()) 
      .then(data => {

        if(document.getElementById("client-buttons")!=null){
        document.getElementById("client-buttons").remove();
        document.getElementsByTagName("table")[0].remove();}

        var body = document.getElementsByTagName("body")[0];
        document.getElementById("last-updated").insertAdjacentHTML("afterend", data);
        

        // ここから日付の成形
        let select = document.getElementById("title");
        let option;
        let table = document.getElementsByTagName("table")[0];
        // let rows = table.rows;
        // for (let i = 1; i < rows.length; i++) {
        //   const dateCell = rows[i].querySelector('td:last-child');
        //   const dateText = dateCell.innerText;
        //   const dateText2 = dateText.match(/\d{1,2}\/\d{1,2} \d{1,2}:\d{1,2}/);
        //   const dateText3 = dateText2[0];
        //   dateCell.innerText = dateText3;
        // }
        // let rows = table.rows;
        // for (let i = 1; i < rows.length; i++) {
        //   const dateCell = rows[i].querySelector('td:last-child');
        //   const dateText = dateCell.innerText;
        //   const dateText2 = dateText.match(/\d{1,2}\/\d{1,2}/);
        //   const dateObj = new Date(dateText2);
        //   const year = dateObj.getFullYear();
        //   const month = dateObj.getMonth() + 1;
        //   const date = dateObj.getDate();
        //   const weekday = ["日", "月", "火", "水", "木", "金", "土"][dateObj.getDay()];
        //   dateCell.innerText = `${month}/${date}(${weekday})`;
        // }
        let rows = table.rows;
        for (let i = 1; i < rows.length; i++) {
          const dateCell = rows[i].querySelector('td:last-child');
          const dateText = dateCell.innerText;
          const dateMatch = dateText.match(/\d{1,2}\/\d{1,2}\s\d{1,2}:\d{1,2}/);
          if (dateMatch !== null) {
            const [dateStr] = dateMatch;
            const date = new Date(`2023/${dateStr}:00`);
            const formattedDate = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            dateCell.innerText = formattedDate;
          }
        }

        // クライアント一覧取得
        const clients = Array.from(new Set([...document.querySelectorAll('table tbody td:nth-child(6)')].map(td => td.textContent)));

        // クライアントが選択された時選択肢作成処理
        let select2 = document.getElementById("client");
        let option2;
        select2.innerHTML = '';
        clients.forEach(aClient => {
            // クライアントが選択中のタスク内容のoptionを作成
            select.innerHTML = '';
            option2 = document.createElement("option");
            option2.text = aClient;
            option2.value = aClient;
            select2.add(option2);  
        });



        // クライアント選択ボタンを作成する
        const client_buttons = document.createElement("div");
        client_buttons.setAttribute("id","client-buttons");
        table.insertAdjacentHTML("beforebegin", client_buttons.outerHTML);
        const clientButtons = document.getElementById('client-buttons');
        clients.forEach((client, index) => {
          // ボタン要素を作成
          const button = document.createElement('button');
          button.textContent = client;
          button.addEventListener('click', () => {
            // クリックされたボタンにactiveクラスを追加
            const currentButton = document.querySelector('#client-buttons button.active');
            if (currentButton) {
              currentButton.classList.remove('active');
            }
            button.classList.add('active');

            // セレクトの中身をクリア
            select.innerHTML = '';

            // 選択してくださいのデフォルトのoptionを作成
            let option = document.createElement("option");
            option.text = "選択してください";
            option.value = "選択してください";
            select.add(option);

            // 新規タスク作成のoptionを作成
            option = document.createElement("option");
            option.text = "新規タスク作成";
            option.value = "新規タスク作成";
            select.add(option);

            // クライアントをフォームに設定
            formClient = document.querySelector("#myForm #client");
            formClient.value = client;

            // クライアントが選択された時選択肢作成処理
            const rows = Array.from(document.querySelectorAll('tbody tr')).slice(1); // ヘッダーを除外
            rows.forEach(row => {
              const clientCell = row.cells[5];
              if (clientCell.textContent === client) {
                // クライアントが選択中のタスク内容のoptionを作成
                option = document.createElement("option");
                option.text = row.cells[0].innerText;
                option.value = row.cells[0].innerText;
                select.add(option);
              } 
            });

            // クライアントが選択された時の表切り替え処理（画面サイズ変更にも行う）
            rows.forEach(row => {
              const clientCell = row.cells[5];
              if (clientCell.textContent === client) {
                row.style.display = (window.innerWidth <= 680) ? 'flex' : 'table-row';
              } else {
                row.style.display = 'none';
              }
            });
          });
          // ボタンを追加
          clientButtons.appendChild(button);
          // 最初のクライアントを選択状態にする
          if (index === 0) {
            button.click();
            button.classList.add('active');
          }
        });
      });
    }
    script1();
    </script> -->

    <!-- レスポンシブ変更時のスクリプト
    <script>
      function handleResize(){
            const currentButton = document.querySelector('#client-buttons button.active');
            const client =currentButton.textContent;
            const rows = Array.from(document.querySelectorAll('tbody tr')).slice(1); // ヘッダーを除外
            rows.forEach(row => {
              const clientCell = row.cells[5];
              if (clientCell.textContent === client) {
                row.style.display = (window.innerWidth <= 680) ? 'flex' : 'table-row';
              } else {
                row.style.display = 'none';
              }
            });}
      window.addEventListener('resize', handleResize);
    </script> -->

    <!-- <script>
      function showOtherTitle() {
        let select = document.getElementById("title");
        let otherTitle = document.getElementById("otherTitle");
        let otherTitleLabel = document.getElementsByClassName("form-label2")[0];
        if (select.value === "新規タスク作成") {
          otherTitle.style.display = "inline-block";
          otherTitleLabel.style.display = "inline-block";
        } else {
          otherTitle.style.display = "none";
          otherTitleLabel.style.display = "none";
        }
      }
    </script> -->


      <script>
        // フォームの送信をハンドルする関数
        const handleSubmit = async (event) => {
        event.preventDefault(); // デフォルトの送信をキャンセル
        const form = document.querySelector('#myForm');
        const formData = new FormData(form);
        const data = {};
        // FormDataオブジェクトから連想配列に変換
        for (const [key, value] of formData.entries()) {
            data[key] = value;
          }
          
        // もし「その他」が選択された場合、テキストボックスの値を利用する
        // if (data["タスク内容"] === "新規タスク作成") {
        //   data["タスク内容"] = data["other:タスク内容"];
        // }
        // delete data["other:タスク内容"]

        const response = await fetch("https://script.google.com/macros/s/AKfycbwUHrw95OqVOt379tLKguyaAVFSyeK8k9anfl0xnrECQtpQXzx6zRyleHJkJwpvCR_QNQ/exec", {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(data),
          mode: 'cors', //CORS対応
        });

        const text = await response.text();
        if (text.includes("Success")) {
          console.log('データが正常に送信されました');
          form.reset(); // フォームの入力値をリセット
        } else {
          console.error(`エラーメッセージ: ${text}`);
        }
        script1();
        };
        const form = document.querySelector('#myForm');
        form.addEventListener('submit', handleSubmit);
      </script>


</body>
</html>